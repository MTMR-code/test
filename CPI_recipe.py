import streamlit as st
import requests
import csv
from io import StringIO

@st.cache_data
def load_data():
    # ä»Šå›ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€URLã‹ã‚‰ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯è¡Œã„ã¾ã›ã‚“ã€‚
    # Streamlitã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ãŒã€ä»Šå›ã¯ã‚³ãƒ¼ãƒ‰ã«ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã—ã¾ã™ã€‚
    # uploaded_file = st.file_uploader("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„", type="csv")
    # if uploaded_file is not None:
    #     csv_reader = csv.reader(StringIO(uploaded_file.getvalue().decode('shift_jis')))
    #     ...

    # æä¾›ã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥èª­ã¿è¾¼ã¿ã¾ã™ã€‚
    with open('zmi2020aa.csv', 'r', encoding='shift_jis') as f:
        csv_reader = csv.reader(f)
        header = next(csv_reader)
        data = list(csv_reader)
    return header, data

header, data = load_data()
if not data:
    st.error("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")
    st.stop()

st.title('ç‰©ä¾¡ãŒå®‰å®šã—ãŸé£Ÿæãƒ¬ã‚·ãƒ”ææ¡ˆã‚¢ãƒ—ãƒª ğŸ³')
st.write("æ¶ˆè²»è€…ç‰©ä¾¡æŒ‡æ•°ï¼ˆCPIï¼‰ã®å‰å¹´æ¯”ãŒå°ã•ã„ã€ä¾¡æ ¼ã®å¤‰å‹•ãŒå®‰å®šã—ã¦ã„ã‚‹é£Ÿæã‚’åŸºã«ãƒ¬ã‚·ãƒ”ã‚’ææ¡ˆã—ã¾ã™ã€‚")

# ä¿®æ­£éƒ¨åˆ†ï¼šCSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼åã«åˆã‚ã›ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç‰¹å®š
try:
    item_index = header.index('é¡ãƒ»å“ç›®')
    y2022_index = header.index('ä»¤å’Œ4å¹´')
    y2023_index = header.index('ä»¤å’Œ5å¹´')
except ValueError:
    st.error("CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã«å¿…è¦ãªåˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ˜ãƒƒãƒ€ãƒ¼åãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚")
    st.stop()

# å„å“ç›®ã®å‰å¹´æ¯”ã‚’è¨ˆç®—
calculated_data = []
for row in data:
    try:
        item = row[item_index]
        # ã€Œé¡ã€ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆä¾‹ï¼šã€Œç©€é¡ã€ã€Œè‚‰é¡ã€ãªã©ï¼‰ã‚’é™¤å¤–
        if 'é¡' in item and len(item) < 4:
            continue
        
        # æ•°å€¤ã«å¤‰æ›ã—ã¦è¨ˆç®—
        val_2022 = float(row[y2022_index])
        val_2023 = float(row[y2023_index])
        
        if val_2022 != 0:
            growth_rate = (val_2023 / val_2022 - 1) * 100
            calculated_data.append({'å“ç›®': item, 'å‰å¹´æ¯”': f'{growth_rate:.2f}%'})
    except (ValueError, IndexError):
        continue

# å‰å¹´æ¯”ã®å°ã•ã„é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ä¸Šä½10ä»¶ã‚’å–å¾—
stable_foods = sorted(calculated_data, key=lambda x: float(x['å‰å¹´æ¯”'].strip('%')))[:10]

st.subheader('ä¾¡æ ¼ãŒå®‰å®šã—ã¦ã„ã‚‹é£Ÿæãƒªã‚¹ãƒˆ')
st.table(stable_foods)

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé£Ÿæã‚’é¸æŠ
selected_food = st.selectbox(
    'ãƒ¬ã‚·ãƒ”ã‚’çŸ¥ã‚ŠãŸã„é£Ÿæã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š',
    [food['å“ç›®'] for food in stable_foods]
)

# ãƒ€ãƒŸãƒ¼ã®ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿
recipes = {
    'è±†è…': {
        'ã‚¸ãƒ£ãƒ³ãƒ«': 'å’Œé£Ÿ',
        'ãƒ¬ã‚·ãƒ”å': 'ç°¡å˜éº»å©†è±†è…',
        'ææ–™': 'è±†è…ã€ã²ãè‚‰ã€é•·ã­ãã€ã«ã‚“ã«ãã€ã—ã‚‡ã†ãŒã€è±†æ¿é†¤',
        'ä½œã‚Šæ–¹': 'ã²ãè‚‰ã¨é¦™å‘³é‡èœã‚’ç‚’ã‚ã€èª¿å‘³æ–™ã¨æ°´ã‚’åŠ ãˆã¦ç…®ç«‹ã¦ã‚‹ã€‚è±†è…ã‚’åŠ ãˆã¦æ¸©ã‚ã‚‹ã€‚'
    },
    'é£Ÿãƒ‘ãƒ³': {
        'ã‚¸ãƒ£ãƒ³ãƒ«': 'æ´‹é£Ÿ',
        'ãƒ¬ã‚·ãƒ”å': 'ã‚«ãƒªã‚«ãƒªãƒãƒ¼ã‚ºãƒˆãƒ¼ã‚¹ãƒˆ',
        'ææ–™': 'é£Ÿãƒ‘ãƒ³ã€ã¨ã‚ã‘ã‚‹ãƒãƒ¼ã‚º',
        'ä½œã‚Šæ–¹': 'é£Ÿãƒ‘ãƒ³ã«ãƒãƒ¼ã‚ºã‚’ä¹—ã›ã€ã‚ªãƒ¼ãƒ–ãƒ³ãƒˆãƒ¼ã‚¹ã‚¿ãƒ¼ã§ç„¼ãè‰²ãŒã¤ãã¾ã§ç„¼ãã€‚'
    },
    'é¶åµ': {
        'ã‚¸ãƒ£ãƒ³ãƒ«': 'å’Œé£Ÿ',
        'ãƒ¬ã‚·ãƒ”å': 'ã ã—å·»ãåµ',
        'ææ–™': 'é¶åµã€ã ã—æ±ã€ç ‚ç³–ã€é†¤æ²¹',
        'ä½œã‚Šæ–¹': 'åµã‚’æº¶ãã€èª¿å‘³æ–™ã¨æ··ãœã¦ç„¼ãã€‚'
    },
    'ç‰›ä¹³': {
        'ã‚¸ãƒ£ãƒ³ãƒ«': 'æ´‹é£Ÿ',
        'ãƒ¬ã‚·ãƒ”å': 'ç‰›ä¹³ãŸã£ã·ã‚Šãƒ›ãƒ¯ã‚¤ãƒˆã‚·ãƒãƒ¥ãƒ¼',
        'ææ–™': 'ç‰›ä¹³ã€é¶è‚‰ã€ã˜ã‚ƒãŒã„ã‚‚ã€ã«ã‚“ã˜ã‚“ã€ç‰ã­ã',
        'ä½œã‚Šæ–¹': 'é‡èœã¨é¶è‚‰ã‚’ç‚’ã‚ã€æ°´ã‚’åŠ ãˆã¦ç…®è¾¼ã‚€ã€‚ç«ãŒé€šã£ãŸã‚‰ç‰›ä¹³ã‚’åŠ ãˆã€ã‚·ãƒãƒ¥ãƒ¼ãƒ«ã‚¦ã§ã¨ã‚ã¿ã‚’ã¤ã‘ã‚‹ã€‚'
    },
    'è±šè‚‰': {
        'ã‚¸ãƒ£ãƒ³ãƒ«': 'ä¸­è¯',
        'ãƒ¬ã‚·ãƒ”å': 'è±šè‚‰ã¨ãƒ”ãƒ¼ãƒãƒ³ã®ç´°åˆ‡ã‚Šç‚’ã‚',
        'ææ–™': 'è±šè‚‰ã€ãƒ”ãƒ¼ãƒãƒ³ã€ç­ã€ã‚ªã‚¤ã‚¹ã‚¿ãƒ¼ã‚½ãƒ¼ã‚¹',
        'ä½œã‚Šæ–¹': 'ç´°åˆ‡ã‚Šã«ã—ãŸè±šè‚‰ã¨é‡èœã‚’ç‚’ã‚ã€èª¿å‘³æ–™ã§å‘³ã‚’èª¿ãˆã‚‹ã€‚'
    },
    'ç‰›è‚‰ï¼ˆå›½ç”£å“ï¼‰': {
        'ã‚¸ãƒ£ãƒ³ãƒ«': 'å’Œé£Ÿ',
        'ãƒ¬ã‚·ãƒ”å': 'ç‰›è‚‰ã®ã—ãã‚Œç…®',
        'ææ–™': 'ç‰›è‚‰ã€ã—ã‚‡ã†ãŒã€é†¤æ²¹ã€ã¿ã‚Šã‚“ã€ç ‚ç³–',
        'ä½œã‚Šæ–¹': 'é‹ã«èª¿å‘³æ–™ã‚’ç…®ç«‹ãŸã›ã€ç´°åˆ‡ã‚Šã«ã—ãŸç‰›è‚‰ã¨ã—ã‚‡ã†ãŒã‚’åŠ ãˆã¦ç‚’ã‚Šç…®ã«ã™ã‚‹ã€‚'
    }
}

if selected_food in recipes:
    st.subheader(f'ã€Œ{selected_food}ã€ã‚’ä½¿ã£ãŸãƒ¬ã‚·ãƒ”')
    recipe_info = recipes[selected_food]
    st.write(f"**ã‚¸ãƒ£ãƒ³ãƒ«:** {recipe_info['ã‚¸ãƒ£ãƒ³ãƒ«']}")
    st.write(f"**ãƒ¬ã‚·ãƒ”å:** {recipe_info['ãƒ¬ã‚·ãƒ”å']}")
    st.write(f"**ææ–™:** {recipe_info['ææ–™']}")
    st.write(f"**ä½œã‚Šæ–¹:** {recipe_info['ä½œã‚Šæ–¹']}")
else:
    st.info("é¸æŠã•ã‚ŒãŸé£Ÿæã®ãƒ¬ã‚·ãƒ”ã¯ç¾åœ¨æº–å‚™ä¸­ã§ã™ã€‚åˆ¥ã®é£Ÿæã‚’ãŠè©¦ã—ãã ã•ã„ã€‚")
